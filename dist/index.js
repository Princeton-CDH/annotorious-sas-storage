(()=>{"use strict";var t={607:function(t,e,n){var a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=a(n(55)),r=a(n(732)),i=new Event("annotations-loaded");e.default=(t,e)=>{const n=new o.default(e.target,e.annotationEndpoint);return n.all().then((e=>{t.setAnnotations(e.items),document.dispatchEvent(i)})),t.on("createAnnotation",(async a=>{a.target.source=(0,r.default)(a.target.source,e);const o=a.id;return a.id=e.annotationEndpoint+"/"+a.id?.replace("#",""),n.create(a).then((()=>{document.dispatchEvent(i)})),t.removeAnnotation(o),t.addAnnotation(a),a})),t.on("updateAnnotation",((a,o)=>{a.id=o.id,a.target.source=(0,r.default)(a.target.source,e),n.update(a),t.addAnnotation(a)})),t.on("deleteAnnotation",(t=>{n.delete(t.id)})),{adapter:n}}},55:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0});class n{constructor(t,e){this.canvasId=t,this.endpointUrl=e}get annotationPageId(){return`${this.endpointUrl}/search?uri=${this.canvasId}`}async create(t){return fetch(`${this.endpointUrl}/create`,{body:JSON.stringify(n.createV2Anno(t)),headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST"}).then((()=>this.all())).catch((()=>this.all()))}async update(t){return fetch(`${this.endpointUrl}/update`,{body:JSON.stringify(n.createV2Anno(t)),headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST"}).then((()=>this.all())).catch((()=>this.all()))}async delete(t){return fetch(`${this.endpointUrl}/destroy?uri=${encodeURIComponent(t)}`,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"DELETE"}).then((()=>this.all())).catch((()=>this.all()))}async get(t){const e=await this.all();return e?e.items.find((e=>e.id===t)):null}async all(){const t=await fetch(this.annotationPageId),e=await t.json();return this.createAnnotationPage(e)}static createV2Anno(t){let e=null;e=Array.isArray(t.body)?t.body.map((t=>this.createV2AnnoBody(t))):this.createV2AnnoBody(t.body);const n={"@id":t.id&&t.id.startsWith("http")?t.id:void 0,"@context":"http://iiif.io/api/presentation/2/context.json","@type":"oa:Annotation",motivation:"oa:commenting",on:{"@type":"oa:SpecificResource",full:t.target.source.id},resource:e};if(t.target.selector){if(Array.isArray(t.target.selector)){const e=t.target.selector.map((t=>{if(t){const e=this.createV2AnnoSelector(t);if(e)return e}}));n.on.selector={"@type":"oa:Choice",default:e[0],item:e[1]}}else{const e=this.createV2AnnoSelector(t.target.selector);e&&(n.on.selector=e)}t.target.source.partOf&&(n.on.within={"@id":t.target.source.partOf.id,"@type":"sc:Manifest"})}return n}static createV2AnnoBody(t){const e={"@type":"tagging"===t.purpose?"oa:Tag":"dctypes:Text",chars:t.value};return t.format&&(e.format=t.format),t.language&&(e.language=t.language),e}static createV2AnnoSelector(t){switch(t.type){case"SvgSelector":return{"@type":"oa:SvgSelector",value:t.value};case"FragmentSelector":return{"@type":"oa:FragmentSelector",value:t.value.replace("xywh=pixel:","xywh=")};default:return null}}createAnnotationPage(t){if(Array.isArray(t)){const e=t.map((t=>n.createV3Anno(t)));return{id:this.annotationPageId,items:e,type:"AnnotationPage"}}return t}static createV3Anno(t){let e=null;e=Array.isArray(t.resource)?t.resource.map((t=>this.createV3AnnoBody(t))):this.createV3AnnoBody(t.resource);let n=t.on;Array.isArray(n)&&([n]=n);const a={selector:n.selector?this.createV3AnnoSelector(n.selector):void 0,source:n.full};return n.within&&(a.source={id:n.full,partOf:{id:n.within["@id"],type:"Manifest"},type:"Canvas"}),{"@context":"http://www.w3.org/ns/anno.jsonld",id:t["@id"],motivation:"commenting",type:"Annotation",target:a,body:e}}static createV3AnnoBody(t){const e={type:"TextualBody",value:t.chars};return t.format&&(e.format=t.format),t.language&&(e.language=t.language),"oa:Tag"===t["@type"]&&(e.purpose="tagging"),e}static createV3AnnoSelector(t){switch(t["@type"]){case"oa:SvgSelector":return{type:"SvgSelector",value:t.value};case"oa:FragmentSelector":return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:t.value?t.value.replace("xywh=","xywh=pixel:"):""};case"oa:Choice":return[t.default?this.createV3AnnoSelector(t.default):null,t.item?this.createV3AnnoSelector(t.item):null];default:return null}}}e.default=n},732:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.default=(t,e)=>("string"==typeof t&&(t={id:e.target,partOf:{id:e.manifest,type:"Manifest"},type:"Canvas"}),t)}},e={},n=function n(a){var o=e[a];if(void 0!==o)return o.exports;var r=e[a]={exports:{}};return t[a].call(r.exports,r,r.exports,n),r.exports}(607);module.exports=n})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LElBQUssaUJBQ0QsTUFBTyxDQUNIUixLQUFNLGNBQ05KLE1BQU9ZLEVBQVdaLE9BRTFCLElBQUssc0JBQ0QsTUFBTyxDQUNISSxLQUFNLG1CQUNOUyxXQUFZLG9DQUVaYixNQUFPWSxFQUFXWixNQUNaWSxFQUFXWixNQUFNdkQsUUFBUSxRQUFTLGVBQ2xDLElBRWQsSUFBSyxZQUVELE1BQU8sQ0FDSG1FLEVBQVduQixRQUNMckMsS0FBS3VELHFCQUFxQkMsRUFBV25CLFNBQ3JDLEtBQ05tQixFQUFXMUMsS0FDTGQsS0FBS3VELHFCQUFxQkMsRUFBVzFDLE1BQ3JDLE1BRWQsUUFDSSxPQUFPLE9BaFJ2QixhLDZEQ09BLFVBdEIyQixDQUN2QjVCLEVBQ0FkLEtBSXFCLGlCQUFWYyxJQUVQQSxFQUFTLENBRUxFLEdBQUloQixFQUFTRSxPQUViZ0UsT0FBUSxDQUNKbEQsR0FBSWhCLEVBQVNzRixTQUNiVixLQUFNLFlBRVZBLEtBQU0sV0FHUDlELEtDckJQeUUsRUFBMkIsR0NFM0JDLEVEQ0osU0FBU0MsRUFBb0JDLEdBRTVCLElBQUlDLEVBQWVKLEVBQXlCRyxHQUM1QyxRQUFxQmpDLElBQWpCa0MsRUFDSCxPQUFPQSxFQUFhQyxRQUdyQixJQUFJQyxFQUFTTixFQUF5QkcsR0FBWSxDQUdqREUsUUFBUyxJQU9WLE9BSEFFLEVBQW9CSixHQUFVSyxLQUFLRixFQUFPRCxRQUFTQyxFQUFRQSxFQUFPRCxRQUFTSCxHQUdwRUksRUFBT0QsUUNsQldILENBQW9CLEsiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS8uL3NyYy9pbmRleC50cyIsIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS8uL3NyYy91dGlscy9TaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyLnRzIiwid2VicGFjazovL2Fubm90b3Jpb3VzLXNhcy1zdG9yYWdlLy4vc3JjL3V0aWxzL2FkanVzdFRhcmdldFNvdXJjZS50cyIsIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS93ZWJwYWNrL2Jvb3RzdHJhcCIsIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS93ZWJwYWNrL3N0YXJ0dXAiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gYW5ub3RvcmlvdXMgcGx1Z2luIHRvIHVzZSBzaW1wbGUgYW5ub3RhdGlvbiBzZXJ2ZXIgYXMgYSBzdG9yYWdlXG5cbmltcG9ydCBTaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyIGZyb20gXCIuL3V0aWxzL1NpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXJcIjtcbmltcG9ydCBhZGp1c3RUYXJnZXRTb3VyY2UgZnJvbSBcIi4vdXRpbHMvYWRqdXN0VGFyZ2V0U291cmNlXCI7XG5pbXBvcnQgdHlwZSB7IEFubm90YXRpb24sIFNhdmVkQW5ub3RhdGlvbiB9IGZyb20gXCIuL3R5cGVzL1YzL0Fubm90YXRpb25cIjtcbmltcG9ydCB0eXBlIHsgQW5ub3RhdGlvblBhZ2UgfSBmcm9tIFwiLi90eXBlcy9WMy9Bbm5vdGF0aW9uUGFnZVwiO1xuaW1wb3J0IHR5cGUgeyBTZXR0aW5ncyB9IGZyb20gXCIuL3R5cGVzL1NldHRpbmdzXCI7XG5cbi8vIGRlZmluZSBhIGN1c3RvbSBldmVudCB0byBpbmRpY2F0ZSB0aGF0IGFubm90YXRpb25zIGhhdmUgYmVlbiBsb2FkZWRcbmNvbnN0IEFubm9Mb2FkRXZlbnQgPSBuZXcgRXZlbnQoXCJhbm5vdGF0aW9ucy1sb2FkZWRcIik7XG5cbi8vIFRPRE86IEFkZCBhIHR5cGVkZWYgZm9yIHRoZSBBbm5vdG9yaW91cyBjbGllbnQgKGFubm8pXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuY29uc3QgQW5ub3RhdGlvblNlcnZlclN0b3JhZ2UgPSAoYW5ubzogYW55LCBzZXR0aW5nczogU2V0dGluZ3MpID0+IHtcbiAgICBjb25zdCBhZGFwdGVyID0gbmV3IFNpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXIoXG4gICAgICAgIHNldHRpbmdzLnRhcmdldCwgLy8gc2hvdWxkIGJlIGNhbnZhcyBpZFxuICAgICAgICBzZXR0aW5ncy5hbm5vdGF0aW9uRW5kcG9pbnQsXG4gICAgKTtcblxuICAgIC8vIGxvYWQgYW5kIGRpc3BsYXkgYW5ub3RhdGlvbnMgZnJvbSBzZXJ2ZXJcbiAgICBhZGFwdGVyLmFsbCgpLnRoZW4oKGFubm90YXRpb25QYWdlOiBBbm5vdGF0aW9uUGFnZSkgPT4ge1xuICAgICAgICBhbm5vLnNldEFubm90YXRpb25zKGFubm90YXRpb25QYWdlLml0ZW1zKTtcbiAgICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChBbm5vTG9hZEV2ZW50KTtcbiAgICB9KTtcblxuICAgIC8vIGNyZWF0ZSBhIG5ldyBhbm5vdGF0aW9uXG4gICAgYW5uby5vbihcImNyZWF0ZUFubm90YXRpb25cIiwgYXN5bmMgKGFubm90YXRpb246IEFubm90YXRpb24pID0+IHtcbiAgICAgICAgYW5ub3RhdGlvbi50YXJnZXQuc291cmNlID0gYWRqdXN0VGFyZ2V0U291cmNlKFxuICAgICAgICAgICAgYW5ub3RhdGlvbi50YXJnZXQuc291cmNlLFxuICAgICAgICAgICAgc2V0dGluZ3MsXG4gICAgICAgICk7XG4gICAgICAgIC8vIHJlYXNzaWduIElEIHRvIGEgVVJJIG9uIHRoZSBhbm5vdGF0aW9uIGVuZHBvaW50XG4gICAgICAgIGNvbnN0IG9sZElkID0gYW5ub3RhdGlvbi5pZDtcbiAgICAgICAgYW5ub3RhdGlvbi5pZCA9IHNldHRpbmdzLmFubm90YXRpb25FbmRwb2ludCArIFwiL1wiICsgYW5ub3RhdGlvbi5pZD8ucmVwbGFjZShcIiNcIiwgXCJcIik7XG4gICAgICAgIGFkYXB0ZXIuY3JlYXRlKGFubm90YXRpb24pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgLy8gYnkgZGVmYXVsdCwgc3RvcmFnZSByZWxvYWRzIGFsbCBhbm5vdGF0aW9ucyBmb3IgdGhpcyBwYWdlO1xuICAgICAgICAgICAgLy8gc2lnbmFsIHRoYXQgYW5ub3RhdGlvbnMgaGF2ZSBiZWVuIGxvYWRlZFxuICAgICAgICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChBbm5vTG9hZEV2ZW50KTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIHJlbW92ZSB0aGUgYW5ub3RhdGlvbiB3aXRoIHRoZSBvbGQgSUQsIGFkZCB0aGUgb25lIHdpdGggdGhlIG5ldyBJRFxuICAgICAgICBhbm5vLnJlbW92ZUFubm90YXRpb24ob2xkSWQpO1xuICAgICAgICBhbm5vLmFkZEFubm90YXRpb24oYW5ub3RhdGlvbik7XG4gICAgICAgIHJldHVybiBhbm5vdGF0aW9uO1xuICAgIH0pO1xuXG4gICAgLy8gdXBkYXRlIGFuIGFubm90YXRpb25cbiAgICBhbm5vLm9uKFxuICAgICAgICBcInVwZGF0ZUFubm90YXRpb25cIixcbiAgICAgICAgKGFubm90YXRpb246IEFubm90YXRpb24sIHByZXZpb3VzOiBBbm5vdGF0aW9uKSA9PiB7XG4gICAgICAgICAgICAvLyBUaGUgcG9zdGVkIGFubm90YXRpb24gc2hvdWxkIGhhdmUgYW4gQGlkIHdoaWNoIGV4aXN0cyBpbiB0aGUgc3RvcmVcbiAgICAgICAgICAgIC8vIGNvbnN0IG5ld0lkID0gYW5ub3RhdGlvbi5pZDsgLy8gZG8gd2UgbmVlZCB0byBkbyBhbnl0aGluZyB3aXRoIHRoaXM/XG4gICAgICAgICAgICBhbm5vdGF0aW9uLmlkID0gcHJldmlvdXMuaWQ7XG4gICAgICAgICAgICAvLyB0YXJnZXQgbmVlZHMgdG8gYmUgdXBkYXRlZCBpZiB0aGUgaW1hZ2Ugc2VsZWN0aW9uIGhhcyBjaGFuZ2VkXG4gICAgICAgICAgICBhbm5vdGF0aW9uLnRhcmdldC5zb3VyY2UgPSBhZGp1c3RUYXJnZXRTb3VyY2UoXG4gICAgICAgICAgICAgICAgYW5ub3RhdGlvbi50YXJnZXQuc291cmNlLFxuICAgICAgICAgICAgICAgIHNldHRpbmdzLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGFkYXB0ZXIudXBkYXRlKGFubm90YXRpb24pO1xuICAgICAgICAgICAgLy8gYWRkIHRoZSBhbm5vdGF0aW9uIHRvIGFubm90b3Jpb3VzIGFnYWluIHRvIG1ha2Ugc3VyZSB0aGUgZGlzcGxheSBpcyB1cCB0byBkYXRlXG4gICAgICAgICAgICBhbm5vLmFkZEFubm90YXRpb24oYW5ub3RhdGlvbik7XG4gICAgICAgIH0sXG4gICAgKTtcblxuICAgIC8vIGRlbGV0ZSBhbiBhbm5vdGF0aW9uXG4gICAgYW5uby5vbihcImRlbGV0ZUFubm90YXRpb25cIiwgKGFubm90YXRpb246IFNhdmVkQW5ub3RhdGlvbikgPT4ge1xuICAgICAgICBhZGFwdGVyLmRlbGV0ZShhbm5vdGF0aW9uLmlkKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHN0b3JhZ2VQbHVnaW4gPSB7XG4gICAgICAgIGFkYXB0ZXI6IGFkYXB0ZXIsXG4gICAgfTtcblxuICAgIHJldHVybiBzdG9yYWdlUGx1Z2luO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgQW5ub3RhdGlvblNlcnZlclN0b3JhZ2U7XG4iLCIvKiBDb252ZXJ0IGJldHdlZW4gdjIgKG9wZW4gYW5ub3RhdGlvbikgYW5kIHYzICh3M2MpIGFubm90YXRpb25zXG4gICBpbiBvcmRlciB0byBicmlkZ2UgYmV0d2VlbiBhbm5vdG9yaW91cyAodzNjKSBhbmQgc2ltcGxlIGFubm90YXRpb24gc2VydmVyICh2MikuXG5cbiAgIEFkYXB0ZWQgZnJvbSBtaXJhZG9yLWFubm90YXRpb25zIGNvZGVcbiAgIGh0dHBzOi8vZ2l0aHViLmNvbS9Qcm9qZWN0TWlyYWRvci9taXJhZG9yLWFubm90YXRpb25zL2Jsb2IvbWFzdGVyL3NyYy9TaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyLmpzXG5cbiovXG5cbmltcG9ydCB0eXBlIHsgQW5ub3RhdGlvbiBhcyBWMkFubm90YXRpb24gfSBmcm9tIFwiLi4vdHlwZXMvVjIvQW5ub3RhdGlvblwiO1xuaW1wb3J0IHR5cGUgeyBBbm5vdGF0aW9uIGFzIFYzQW5ub3RhdGlvbiB9IGZyb20gXCIuLi90eXBlcy9WMy9Bbm5vdGF0aW9uXCI7XG5pbXBvcnQgdHlwZSB7IEFubm90YXRpb25QYWdlIH0gZnJvbSBcIi4uL3R5cGVzL1YzL0Fubm90YXRpb25QYWdlXCI7XG5pbXBvcnQgdHlwZSB7IEJvZHkgYXMgVjJCb2R5IH0gZnJvbSBcIi4uL3R5cGVzL1YyL0JvZHlcIjtcbmltcG9ydCB0eXBlIHsgQm9keSBhcyBWM0JvZHkgfSBmcm9tIFwiLi4vdHlwZXMvVjMvQm9keVwiO1xuaW1wb3J0IHR5cGUgeyBTZWxlY3RvciBhcyBWMlNlbGVjdG9yIH0gZnJvbSBcIi4uL3R5cGVzL1YyL1NlbGVjdG9yXCI7XG5pbXBvcnQgdHlwZSB7IFNlbGVjdG9yIGFzIFYzU2VsZWN0b3IgfSBmcm9tIFwiLi4vdHlwZXMvVjMvU2VsZWN0b3JcIjtcbmltcG9ydCB0eXBlIHsgU291cmNlIH0gZnJvbSBcIi4uL3R5cGVzL1YzL1NvdXJjZVwiO1xuaW1wb3J0IHR5cGUgeyBUYXJnZXQgfSBmcm9tIFwiLi4vdHlwZXMvVjMvVGFyZ2V0XCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXIge1xuICAgIGNhbnZhc0lkOiBzdHJpbmc7XG5cbiAgICBlbmRwb2ludFVybDogc3RyaW5nO1xuXG4gICAgLyoqICovXG4gICAgY29uc3RydWN0b3IoY2FudmFzSWQ6IHN0cmluZywgZW5kcG9pbnRVcmw6IHN0cmluZykge1xuICAgICAgICB0aGlzLmNhbnZhc0lkID0gY2FudmFzSWQ7XG4gICAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBlbmRwb2ludFVybDtcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICBnZXQgYW5ub3RhdGlvblBhZ2VJZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy5lbmRwb2ludFVybH0vc2VhcmNoP3VyaT0ke3RoaXMuY2FudmFzSWR9YDtcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICBhc3luYyBjcmVhdGUoYW5ub3RhdGlvbjogVjNBbm5vdGF0aW9uKSB7XG4gICAgICAgIHJldHVybiBmZXRjaChgJHt0aGlzLmVuZHBvaW50VXJsfS9jcmVhdGVgLCB7XG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgICAgICBTaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyLmNyZWF0ZVYyQW5ubyhhbm5vdGF0aW9uKSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgQWNjZXB0OiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5hbGwoKSlcbiAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB0aGlzLmFsbCgpKTtcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICBhc3luYyB1cGRhdGUoYW5ub3RhdGlvbjogVjNBbm5vdGF0aW9uKSB7XG4gICAgICAgIHJldHVybiBmZXRjaChgJHt0aGlzLmVuZHBvaW50VXJsfS91cGRhdGVgLCB7XG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgICAgICBTaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyLmNyZWF0ZVYyQW5ubyhhbm5vdGF0aW9uKSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgQWNjZXB0OiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5hbGwoKSlcbiAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB0aGlzLmFsbCgpKTtcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICBhc3luYyBkZWxldGUoYW5ub0lkOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGZldGNoKFxuICAgICAgICAgICAgYCR7dGhpcy5lbmRwb2ludFVybH0vZGVzdHJveT91cmk9JHtlbmNvZGVVUklDb21wb25lbnQoYW5ub0lkKX1gLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgQWNjZXB0OiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFwiREVMRVRFXCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICApXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmFsbCgpKVxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHRoaXMuYWxsKCkpO1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIGFzeW5jIGdldChhbm5vSWQ6IHN0cmluZykge1xuICAgICAgICAvLyBTQVMgZG9lcyBub3QgaGF2ZSBHRVQgZm9yIGEgc2luZ2xlIGFubm90YXRpb25cbiAgICAgICAgY29uc3QgYW5ub3RhdGlvblBhZ2UgPSBhd2FpdCB0aGlzLmFsbCgpO1xuICAgICAgICBpZiAoYW5ub3RhdGlvblBhZ2UpIHtcbiAgICAgICAgICAgIHJldHVybiBhbm5vdGF0aW9uUGFnZS5pdGVtcy5maW5kKFxuICAgICAgICAgICAgICAgIChpdGVtOiBWM0Fubm90YXRpb24pID0+IGl0ZW0uaWQgPT09IGFubm9JZCxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqIFJldHVybnMgYW4gQW5ub3RhdGlvblBhZ2Ugd2l0aCBhbGwgYW5ub3RhdGlvbnMgKi9cbiAgICBhc3luYyBhbGwoKTogUHJvbWlzZTxBbm5vdGF0aW9uUGFnZT4ge1xuICAgICAgICBjb25zdCByZXNwID0gYXdhaXQgZmV0Y2godGhpcy5hbm5vdGF0aW9uUGFnZUlkKTtcbiAgICAgICAgY29uc3QgYW5ub3MgPSBhd2FpdCByZXNwLmpzb24oKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlQW5ub3RhdGlvblBhZ2UoYW5ub3MpO1xuICAgIH1cblxuICAgIC8qKiBDcmVhdGVzIGEgVjIgYW5ub3RhdGlvbiBmcm9tIGEgVjMgYW5ub3RhdGlvbiAqL1xuICAgIHN0YXRpYyBjcmVhdGVWMkFubm8odjNhbm5vOiBWM0Fubm90YXRpb24pOiBWMkFubm90YXRpb24ge1xuICAgICAgICBsZXQgcmVzb3VyY2UgPSBudWxsO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2M2Fubm8uYm9keSkpIHtcbiAgICAgICAgICAgIHJlc291cmNlID0gdjNhbm5vLmJvZHkubWFwKChiKSA9PiB0aGlzLmNyZWF0ZVYyQW5ub0JvZHkoYikpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb3VyY2UgPSB0aGlzLmNyZWF0ZVYyQW5ub0JvZHkodjNhbm5vLmJvZHkpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHYyYW5ubzogVjJBbm5vdGF0aW9uID0ge1xuICAgICAgICAgICAgLy8gY29weSBpZCBpZiBpdCBpcyBTQVMtZ2VuZXJhdGVkXG4gICAgICAgICAgICAvLyBUT0RPOiBXaGF0IGlkIHRvIHVzZSBpZiBpdCBpcyBub3Q/XG4gICAgICAgICAgICBcIkBpZFwiOlxuICAgICAgICAgICAgICAgIHYzYW5uby5pZCAmJiB2M2Fubm8uaWQuc3RhcnRzV2l0aChcImh0dHBcIilcbiAgICAgICAgICAgICAgICAgICAgPyB2M2Fubm8uaWRcbiAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBcIkBjb250ZXh0XCI6IFwiaHR0cDovL2lpaWYuaW8vYXBpL3ByZXNlbnRhdGlvbi8yL2NvbnRleHQuanNvblwiLFxuICAgICAgICAgICAgXCJAdHlwZVwiOiBcIm9hOkFubm90YXRpb25cIixcbiAgICAgICAgICAgIG1vdGl2YXRpb246IFwib2E6Y29tbWVudGluZ1wiLCAvLyBUT0RPOiB1c2UgdjNhbm5vLm1vdGl2YXRpb25cbiAgICAgICAgICAgIG9uOiB7XG4gICAgICAgICAgICAgICAgXCJAdHlwZVwiOiBcIm9hOlNwZWNpZmljUmVzb3VyY2VcIixcbiAgICAgICAgICAgICAgICBmdWxsOiAodjNhbm5vLnRhcmdldC5zb3VyY2UgYXMgU291cmNlKS5pZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZXNvdXJjZSxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHYzYW5uby50YXJnZXQuc2VsZWN0b3IpIHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHYzYW5uby50YXJnZXQuc2VsZWN0b3IpKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0b3JzID0gdjNhbm5vLnRhcmdldC5zZWxlY3Rvci5tYXAoKHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHYyU2VsZWN0b3IgPSB0aGlzLmNyZWF0ZVYyQW5ub1NlbGVjdG9yKHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYyU2VsZWN0b3IpIHJldHVybiB2MlNlbGVjdG9yO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy8gY3JlYXRlIGNob2ljZSwgYXNzdW1pbmcgdHdvIGVsZW1lbnRzIGFuZCAwIGlzIGRlZmF1bHRcbiAgICAgICAgICAgICAgICB2MmFubm8ub24uc2VsZWN0b3IgPSB7XG4gICAgICAgICAgICAgICAgICAgIFwiQHR5cGVcIjogXCJvYTpDaG9pY2VcIixcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogc2VsZWN0b3JzWzBdLFxuICAgICAgICAgICAgICAgICAgICBpdGVtOiBzZWxlY3RvcnNbMV0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdjJTZWxlY3RvciA9IHRoaXMuY3JlYXRlVjJBbm5vU2VsZWN0b3IoXG4gICAgICAgICAgICAgICAgICAgIHYzYW5uby50YXJnZXQuc2VsZWN0b3IsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBpZiAodjJTZWxlY3RvcikgdjJhbm5vLm9uLnNlbGVjdG9yID0gdjJTZWxlY3RvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICgodjNhbm5vLnRhcmdldC5zb3VyY2UgYXMgU291cmNlKS5wYXJ0T2YpIHtcbiAgICAgICAgICAgICAgICB2MmFubm8ub24ud2l0aGluID0ge1xuICAgICAgICAgICAgICAgICAgICBcIkBpZFwiOiAodjNhbm5vLnRhcmdldC5zb3VyY2UgYXMgU291cmNlKS5wYXJ0T2YuaWQsXG4gICAgICAgICAgICAgICAgICAgIFwiQHR5cGVcIjogXCJzYzpNYW5pZmVzdFwiLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHYyYW5ubztcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICBzdGF0aWMgY3JlYXRlVjJBbm5vQm9keSh2M2JvZHk6IFYzQm9keSkge1xuICAgICAgICBjb25zdCB2MmJvZHk6IFYyQm9keSA9IHtcbiAgICAgICAgICAgIFwiQHR5cGVcIjogdjNib2R5LnB1cnBvc2UgPT09IFwidGFnZ2luZ1wiID8gXCJvYTpUYWdcIiA6IFwiZGN0eXBlczpUZXh0XCIsXG4gICAgICAgICAgICBjaGFyczogdjNib2R5LnZhbHVlLFxuICAgICAgICB9O1xuICAgICAgICBpZiAodjNib2R5LmZvcm1hdCkge1xuICAgICAgICAgICAgdjJib2R5LmZvcm1hdCA9IHYzYm9keS5mb3JtYXQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHYzYm9keS5sYW5ndWFnZSkge1xuICAgICAgICAgICAgdjJib2R5Lmxhbmd1YWdlID0gdjNib2R5Lmxhbmd1YWdlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2MmJvZHk7XG4gICAgfVxuXG4gICAgLyoqICovXG4gICAgc3RhdGljIGNyZWF0ZVYyQW5ub1NlbGVjdG9yKHYzc2VsZWN0b3I6IFYzU2VsZWN0b3IpOiBWMlNlbGVjdG9yIHwgbnVsbCB7XG4gICAgICAgIHN3aXRjaCAodjNzZWxlY3Rvci50eXBlKSB7XG4gICAgICAgICAgICBjYXNlIFwiU3ZnU2VsZWN0b3JcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBcIkB0eXBlXCI6IFwib2E6U3ZnU2VsZWN0b3JcIixcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHYzc2VsZWN0b3IudmFsdWUsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNhc2UgXCJGcmFnbWVudFNlbGVjdG9yXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgXCJAdHlwZVwiOiBcIm9hOkZyYWdtZW50U2VsZWN0b3JcIixcbiAgICAgICAgICAgICAgICAgICAgLy8gU0FTIHVzZXMgbG9jYXRpb24gaW4geHl3aD14LHksdyxoIGZvcm1hdDsgYW5ub3RvcmlvdXMgdXNlcyBwaXhlbDp4LHksdyxoXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2M3NlbGVjdG9yLnZhbHVlLnJlcGxhY2UoXCJ4eXdoPXBpeGVsOlwiLCBcInh5d2g9XCIpLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIENyZWF0ZXMgYW4gQW5ub3RhdGlvblBhZ2UgZnJvbSBhIGxpc3Qgb2YgVjIgYW5ub3RhdGlvbnMgKi9cbiAgICBjcmVhdGVBbm5vdGF0aW9uUGFnZSh2MmFubm9zOiBWMkFubm90YXRpb25bXSk6IEFubm90YXRpb25QYWdlIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodjJhbm5vcykpIHtcbiAgICAgICAgICAgIGNvbnN0IHYzYW5ub3MgPSB2MmFubm9zLm1hcCgoYSkgPT5cbiAgICAgICAgICAgICAgICBTaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyLmNyZWF0ZVYzQW5ubyhhKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGlkOiB0aGlzLmFubm90YXRpb25QYWdlSWQsXG4gICAgICAgICAgICAgICAgaXRlbXM6IHYzYW5ub3MsXG4gICAgICAgICAgICAgICAgdHlwZTogXCJBbm5vdGF0aW9uUGFnZVwiLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdjJhbm5vcztcbiAgICB9XG5cbiAgICAvKiogQ3JlYXRlcyBhIFYzIGFubm90YXRpb24gZnJvbSBhIFYyIGFubm90YXRpb24gKi9cbiAgICBzdGF0aWMgY3JlYXRlVjNBbm5vKHYyYW5ubzogVjJBbm5vdGF0aW9uKTogVjNBbm5vdGF0aW9uIHtcbiAgICAgICAgbGV0IGJvZHkgPSBudWxsO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2MmFubm8ucmVzb3VyY2UpKSB7XG4gICAgICAgICAgICBib2R5ID0gdjJhbm5vLnJlc291cmNlLm1hcCgoYjogVjJCb2R5KSA9PiB0aGlzLmNyZWF0ZVYzQW5ub0JvZHkoYikpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYm9keSA9IHRoaXMuY3JlYXRlVjNBbm5vQm9keSh2MmFubm8ucmVzb3VyY2UpO1xuICAgICAgICB9XG4gICAgICAgIGxldCB2MnRhcmdldCA9IHYyYW5uby5vbjtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodjJ0YXJnZXQpKSB7XG4gICAgICAgICAgICBbdjJ0YXJnZXRdID0gdjJ0YXJnZXQ7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGFyZ2V0OiBUYXJnZXQgPSB7XG4gICAgICAgICAgICBzZWxlY3RvcjogdjJ0YXJnZXQuc2VsZWN0b3JcbiAgICAgICAgICAgICAgICA/IHRoaXMuY3JlYXRlVjNBbm5vU2VsZWN0b3IodjJ0YXJnZXQuc2VsZWN0b3IpXG4gICAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBzb3VyY2U6IHYydGFyZ2V0LmZ1bGwsXG4gICAgICAgIH07XG4gICAgICAgIGlmICh2MnRhcmdldC53aXRoaW4pIHtcbiAgICAgICAgICAgIHRhcmdldC5zb3VyY2UgPSB7XG4gICAgICAgICAgICAgICAgaWQ6IHYydGFyZ2V0LmZ1bGwsXG4gICAgICAgICAgICAgICAgcGFydE9mOiB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiB2MnRhcmdldC53aXRoaW5bXCJAaWRcIl0sXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiTWFuaWZlc3RcIixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHR5cGU6IFwiQ2FudmFzXCIsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBcIkBjb250ZXh0XCI6IFwiaHR0cDovL3d3dy53My5vcmcvbnMvYW5uby5qc29ubGRcIixcbiAgICAgICAgICAgIGlkOiB2MmFubm9bXCJAaWRcIl0sXG4gICAgICAgICAgICBtb3RpdmF0aW9uOiBcImNvbW1lbnRpbmdcIixcbiAgICAgICAgICAgIHR5cGU6IFwiQW5ub3RhdGlvblwiLFxuICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgYm9keSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICBzdGF0aWMgY3JlYXRlVjNBbm5vQm9keSh2MmJvZHk6IFYyQm9keSk6IFYzQm9keSB7XG4gICAgICAgIGNvbnN0IHYzYm9keTogVjNCb2R5ID0ge1xuICAgICAgICAgICAgdHlwZTogXCJUZXh0dWFsQm9keVwiLFxuICAgICAgICAgICAgdmFsdWU6IHYyYm9keS5jaGFycyxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHYyYm9keS5mb3JtYXQpIHtcbiAgICAgICAgICAgIHYzYm9keS5mb3JtYXQgPSB2MmJvZHkuZm9ybWF0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh2MmJvZHkubGFuZ3VhZ2UpIHtcbiAgICAgICAgICAgIHYzYm9keS5sYW5ndWFnZSA9IHYyYm9keS5sYW5ndWFnZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodjJib2R5W1wiQHR5cGVcIl0gPT09IFwib2E6VGFnXCIpIHtcbiAgICAgICAgICAgIHYzYm9keS5wdXJwb3NlID0gXCJ0YWdnaW5nXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHYzYm9keTtcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIHN0YXRpYyBjcmVhdGVWM0Fubm9TZWxlY3Rvcih2MnNlbGVjdG9yOiBWMlNlbGVjdG9yKTogYW55IHtcbiAgICAgICAgLy8gVE9ETzogdHlwZS1zYWZlIHRoaXMgcmV0dXJuIHZhbHVlXG4gICAgICAgIHN3aXRjaCAodjJzZWxlY3RvcltcIkB0eXBlXCJdKSB7XG4gICAgICAgICAgICBjYXNlIFwib2E6U3ZnU2VsZWN0b3JcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiBcIlN2Z1NlbGVjdG9yXCIsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2MnNlbGVjdG9yLnZhbHVlLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjYXNlIFwib2E6RnJhZ21lbnRTZWxlY3RvclwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiRnJhZ21lbnRTZWxlY3RvclwiLFxuICAgICAgICAgICAgICAgICAgICBjb25mb3Jtc1RvOiBcImh0dHA6Ly93d3cudzMub3JnL1RSL21lZGlhLWZyYWdzL1wiLFxuICAgICAgICAgICAgICAgICAgICAvLyBTQVMgcmV0dXJucyBsb2NhdGlvbiBpbiB4eXdoPXgseSx3LGggZm9ybWF0OyBhbm5vdG9yaW91cyB1c2VzIHBpeGVsOngseSx3LGhcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHYyc2VsZWN0b3IudmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgID8gdjJzZWxlY3Rvci52YWx1ZS5yZXBsYWNlKFwieHl3aD1cIiwgXCJ4eXdoPXBpeGVsOlwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBcIlwiLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjYXNlIFwib2E6Q2hvaWNlXCI6XG4gICAgICAgICAgICAgICAgLyogY3JlYXRlIGFsdGVybmF0ZSBzZWxlY3RvcnMgKi9cbiAgICAgICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgICAgICB2MnNlbGVjdG9yLmRlZmF1bHRcbiAgICAgICAgICAgICAgICAgICAgICAgID8gdGhpcy5jcmVhdGVWM0Fubm9TZWxlY3Rvcih2MnNlbGVjdG9yLmRlZmF1bHQpXG4gICAgICAgICAgICAgICAgICAgICAgICA6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHYyc2VsZWN0b3IuaXRlbVxuICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmNyZWF0ZVYzQW5ub1NlbGVjdG9yKHYyc2VsZWN0b3IuaXRlbSlcbiAgICAgICAgICAgICAgICAgICAgICAgIDogbnVsbCxcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cbn1cbiIsImltcG9ydCB7IFNldHRpbmdzIH0gZnJvbSBcIi4uL3R5cGVzL1NldHRpbmdzXCI7XG5pbXBvcnQgeyBTb3VyY2UgfSBmcm9tIFwiLi4vdHlwZXMvVjMvU291cmNlXCI7XG5cbmNvbnN0IGFkanVzdFRhcmdldFNvdXJjZSA9IChcbiAgICBzb3VyY2U6IFNvdXJjZSB8IHN0cmluZyxcbiAgICBzZXR0aW5nczogU2V0dGluZ3MsXG4pOiBTb3VyY2UgPT4ge1xuICAgIC8vIGFubm90b3Jpb3VzIHNldHMgdGhlIHRhcmdldCBzb3VyY2UgYXMgYSBzdHJpbmcgaWQ7XG4gICAgLy8gd2UgbmVlZCB0byBzdHJ1Y3R1cmUgaXQgdG8gYWRkIGNhbnZhcy9tYW5pZmVzdCBpbmZvXG4gICAgaWYgKHR5cGVvZiBzb3VyY2UgPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAvLyBhZGQgbWFuaWZlc3QgaWQgdG8gYW5ub3RhdGlvblxuICAgICAgICBzb3VyY2UgPSB7XG4gICAgICAgICAgICAvLyB1c2UgdGhlIGNvbmZpZ3VyZWQgdGFyZ2V0IChzaG91bGQgYmUgY2FudmFzIGlkKVxuICAgICAgICAgICAgaWQ6IHNldHRpbmdzLnRhcmdldCxcbiAgICAgICAgICAgIC8vIGxpbmsgdG8gY29udGFpbmluZyBtYW5pZmVzdFxuICAgICAgICAgICAgcGFydE9mOiB7XG4gICAgICAgICAgICAgICAgaWQ6IHNldHRpbmdzLm1hbmlmZXN0LFxuICAgICAgICAgICAgICAgIHR5cGU6IFwiTWFuaWZlc3RcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0eXBlOiBcIkNhbnZhc1wiLFxuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gc291cmNlO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgYWRqdXN0VGFyZ2V0U291cmNlO1xuIiwiLy8gVGhlIG1vZHVsZSBjYWNoZVxudmFyIF9fd2VicGFja19tb2R1bGVfY2FjaGVfXyA9IHt9O1xuXG4vLyBUaGUgcmVxdWlyZSBmdW5jdGlvblxuZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkge1xuXHQvLyBDaGVjayBpZiBtb2R1bGUgaXMgaW4gY2FjaGVcblx0dmFyIGNhY2hlZE1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF07XG5cdGlmIChjYWNoZWRNb2R1bGUgIT09IHVuZGVmaW5lZCkge1xuXHRcdHJldHVybiBjYWNoZWRNb2R1bGUuZXhwb3J0cztcblx0fVxuXHQvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKVxuXHR2YXIgbW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXSA9IHtcblx0XHQvLyBubyBtb2R1bGUuaWQgbmVlZGVkXG5cdFx0Ly8gbm8gbW9kdWxlLmxvYWRlZCBuZWVkZWRcblx0XHRleHBvcnRzOiB7fVxuXHR9O1xuXG5cdC8vIEV4ZWN1dGUgdGhlIG1vZHVsZSBmdW5jdGlvblxuXHRfX3dlYnBhY2tfbW9kdWxlc19fW21vZHVsZUlkXS5jYWxsKG1vZHVsZS5leHBvcnRzLCBtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTtcblxuXHQvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZVxuXHRyZXR1cm4gbW9kdWxlLmV4cG9ydHM7XG59XG5cbiIsIi8vIHN0YXJ0dXBcbi8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0c1xuLy8gVGhpcyBlbnRyeSBtb2R1bGUgaXMgcmVmZXJlbmNlZCBieSBvdGhlciBtb2R1bGVzIHNvIGl0IGNhbid0IGJlIGlubGluZWRcbnZhciBfX3dlYnBhY2tfZXhwb3J0c19fID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2MDcpO1xuIl0sIm5hbWVzIjpbIkFubm9Mb2FkRXZlbnQiLCJFdmVudCIsImFubm8iLCJzZXR0aW5ncyIsImFkYXB0ZXIiLCJ0YXJnZXQiLCJhbm5vdGF0aW9uRW5kcG9pbnQiLCJhbGwiLCJ0aGVuIiwiYW5ub3RhdGlvblBhZ2UiLCJzZXRBbm5vdGF0aW9ucyIsIml0ZW1zIiwiZG9jdW1lbnQiLCJkaXNwYXRjaEV2ZW50Iiwib24iLCJhc3luYyIsImFubm90YXRpb24iLCJzb3VyY2UiLCJvbGRJZCIsImlkIiwicmVwbGFjZSIsImNyZWF0ZSIsInJlbW92ZUFubm90YXRpb24iLCJhZGRBbm5vdGF0aW9uIiwicHJldmlvdXMiLCJ1cGRhdGUiLCJkZWxldGUiLCJTaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyIiwiY29uc3RydWN0b3IiLCJjYW52YXNJZCIsImVuZHBvaW50VXJsIiwidGhpcyIsImFubm90YXRpb25QYWdlSWQiLCJmZXRjaCIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwiY3JlYXRlVjJBbm5vIiwiaGVhZGVycyIsIkFjY2VwdCIsIm1ldGhvZCIsImNhdGNoIiwiYW5ub0lkIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwiZmluZCIsIml0ZW0iLCJyZXNwIiwiYW5ub3MiLCJqc29uIiwiY3JlYXRlQW5ub3RhdGlvblBhZ2UiLCJzdGF0aWMiLCJ2M2Fubm8iLCJyZXNvdXJjZSIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsImIiLCJjcmVhdGVWMkFubm9Cb2R5IiwidjJhbm5vIiwic3RhcnRzV2l0aCIsInVuZGVmaW5lZCIsIm1vdGl2YXRpb24iLCJmdWxsIiwic2VsZWN0b3IiLCJzZWxlY3RvcnMiLCJzIiwidjJTZWxlY3RvciIsImNyZWF0ZVYyQW5ub1NlbGVjdG9yIiwiZGVmYXVsdCIsInBhcnRPZiIsIndpdGhpbiIsInYzYm9keSIsInYyYm9keSIsInB1cnBvc2UiLCJjaGFycyIsInZhbHVlIiwiZm9ybWF0IiwibGFuZ3VhZ2UiLCJ2M3NlbGVjdG9yIiwidHlwZSIsInYyYW5ub3MiLCJ2M2Fubm9zIiwiYSIsImNyZWF0ZVYzQW5ubyIsImNyZWF0ZVYzQW5ub0JvZHkiLCJ2MnRhcmdldCIsImNyZWF0ZVYzQW5ub1NlbGVjdG9yIiwidjJzZWxlY3RvciIsImNvbmZvcm1zVG8iLCJtYW5pZmVzdCIsIl9fd2VicGFja19tb2R1bGVfY2FjaGVfXyIsIl9fd2VicGFja19leHBvcnRzX18iLCJfX3dlYnBhY2tfcmVxdWlyZV9fIiwibW9kdWxlSWQiLCJjYWNoZWRNb2R1bGUiLCJleHBvcnRzIiwibW9kdWxlIiwiX193ZWJwYWNrX21vZHVsZXNfXyIsImNhbGwiXSwic291cmNlUm9vdCI6IiJ9