(()=>{"use strict";var t={607:function(t,e,n){var a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=a(n(55)),r=a(n(732)),i=new Event("annotations-loaded");e.default=class{constructor(t,e){this.anno=t,this.settings=e,this.adapter=new o.default(e.target,e.annotationEndpoint),this.anno.on("createAnnotation",this.handleCreateAnnotation.bind(this)),this.anno.on("updateAnnotation",this.handleUpdateAnnotation.bind(this)),this.anno.on("deleteAnnotation",this.handleDeleteAnnotation.bind(this)),this.adapter.all().then((t=>{this.anno.setAnnotations(t.items),document.dispatchEvent(i)}))}async handleCreateAnnotation(t){return t.target.source=(0,r.default)(t.target.source,this.settings),this.adapter.create(t).then((()=>{document.dispatchEvent(i)})),this.anno.addAnnotation(t),t}handleUpdateAnnotation(t,e){t.id=e.id,t.target.source=(0,r.default)(t.target.source,this.settings),this.adapter.update(t),this.anno.addAnnotation(t)}handleDeleteAnnotation(t){this.adapter.delete(t.id)}}},55:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0});class n{constructor(t,e){this.canvasId=t,this.endpointUrl=e}get annotationPageId(){return`${this.endpointUrl}/search?uri=${this.canvasId}`}async create(t){return fetch(`${this.endpointUrl}/create`,{body:JSON.stringify(n.createV2Anno(t)),headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST"}).then((()=>this.all())).catch((()=>this.all()))}async update(t){return fetch(`${this.endpointUrl}/update`,{body:JSON.stringify(n.createV2Anno(t)),headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST"}).then((()=>this.all())).catch((()=>this.all()))}async delete(t){return fetch(`${this.endpointUrl}/destroy?uri=${encodeURIComponent(t)}`,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"DELETE"}).then((()=>this.all())).catch((()=>this.all()))}async get(t){const e=await this.all();return e?e.items.find((e=>e.id===t)):null}async all(){const t=await fetch(this.annotationPageId),e=await t.json();return this.createAnnotationPage(e)}static createV2Anno(t){let e=null;e=Array.isArray(t.body)?t.body.map((t=>this.createV2AnnoBody(t))):this.createV2AnnoBody(t.body);const n={"@id":t.id&&t.id.startsWith("http")?t.id:void 0,"@context":"http://iiif.io/api/presentation/2/context.json","@type":"oa:Annotation",motivation:"oa:commenting",on:{"@type":"oa:SpecificResource",full:t.target.source.id},resource:e};if(t.target.selector){if(Array.isArray(t.target.selector)){const e=t.target.selector.map((t=>{if(t){const e=this.createV2AnnoSelector(t);if(e)return e}}));n.on.selector={"@type":"oa:Choice",default:e[0],item:e[1]}}else{const e=this.createV2AnnoSelector(t.target.selector);e&&(n.on.selector=e)}t.target.source.partOf&&(n.on.within={"@id":t.target.source.partOf.id,"@type":"sc:Manifest"})}return n}static createV2AnnoBody(t){const e={"@type":"tagging"===t.purpose?"oa:Tag":"dctypes:Text",chars:t.value};return t.format&&(e.format=t.format),t.language&&(e.language=t.language),e}static createV2AnnoSelector(t){switch(t.type){case"SvgSelector":return{"@type":"oa:SvgSelector",value:t.value};case"FragmentSelector":return{"@type":"oa:FragmentSelector",value:t.value.replace("xywh=pixel:","xywh=")};default:return null}}createAnnotationPage(t){if(Array.isArray(t)){const e=t.map((t=>n.createV3Anno(t)));return{id:this.annotationPageId,items:e,type:"AnnotationPage"}}return t}static createV3Anno(t){let e=null;e=Array.isArray(t.resource)?t.resource.map((t=>this.createV3AnnoBody(t))):this.createV3AnnoBody(t.resource);let n=t.on;Array.isArray(n)&&([n]=n);const a={selector:n.selector?this.createV3AnnoSelector(n.selector):void 0,source:n.full};return n.within&&(a.source={id:n.full,partOf:{id:n.within["@id"],type:"Manifest"},type:"Canvas"}),{"@context":"http://www.w3.org/ns/anno.jsonld",id:t["@id"],motivation:"commenting",type:"Annotation",target:a,body:e}}static createV3AnnoBody(t){const e={type:"TextualBody",value:t.chars};return t.format&&(e.format=t.format),t.language&&(e.language=t.language),"oa:Tag"===t["@type"]&&(e.purpose="tagging"),e}static createV3AnnoSelector(t){switch(t["@type"]){case"oa:SvgSelector":return{type:"SvgSelector",value:t.value};case"oa:FragmentSelector":return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:t.value?t.value.replace("xywh=","xywh=pixel:"):""};case"oa:Choice":return[t.default?this.createV3AnnoSelector(t.default):null,t.item?this.createV3AnnoSelector(t.item):null];default:return null}}}e.default=n},732:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.default=(t,e)=>("string"==typeof t&&(t={id:e.target,partOf:{id:e.manifest,type:"Manifest"},type:"Canvas"}),t)}},e={},n=function n(a){var o=e[a];if(void 0!==o)return o.exports;var r=e[a]={exports:{}};return t[a].call(r.exports,r,r.exports,n),r.exports}(607);module.exports=n})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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V0FDUE4sRUFBT00sU0FBV0wsRUFBT0ssVUFFTCxXQUFwQkwsRUFBTyxXQUNQRCxFQUFPRSxRQUFVLFdBRWRGLEVBS1hyQiw0QkFBNEJzQyxHQUV4QixPQUFRQSxFQUFXLFVBQ2YsSUFBSyxpQkFDRCxNQUFPLENBQ0hULEtBQU0sY0FDTkosTUFBT2EsRUFBV2IsT0FFMUIsSUFBSyxzQkFDRCxNQUFPLENBQ0hJLEtBQU0sbUJBQ05VLFdBQVksb0NBRVpkLE1BQU9hLEVBQVdiLE1BQ1phLEVBQVdiLE1BQU1LLFFBQVEsUUFBUyxlQUNsQyxJQUVkLElBQUssWUFFRCxNQUFPLENBQ0hRLEVBQVdwQixRQUNMaEUsS0FBS21GLHFCQUFxQkMsRUFBV3BCLFNBQ3JDLEtBQ05vQixFQUFXM0MsS0FDTHpDLEtBQUttRixxQkFBcUJDLEVBQVczQyxNQUNyQyxNQUVkLFFBQ0ksT0FBTyxPQWhSdkIsYSw2RENPQSxVQXRCMkIsQ0FDdkJ2QixFQUNBbkIsS0FJcUIsaUJBQVZtQixJQUVQQSxFQUFTLENBRUxJLEdBQUl2QixFQUFTRyxPQUViK0QsT0FBUSxDQUNKM0MsR0FBSXZCLEVBQVN1RixTQUNiWCxLQUFNLFlBRVZBLEtBQU0sV0FHUHpELEtDckJQcUUsRUFBMkIsR0NFM0JDLEVEQ0osU0FBU0MsRUFBb0JDLEdBRTVCLElBQUlDLEVBQWVKLEVBQXlCRyxHQUM1QyxRQUFxQmxDLElBQWpCbUMsRUFDSCxPQUFPQSxFQUFhQyxRQUdyQixJQUFJQyxFQUFTTixFQUF5QkcsR0FBWSxDQUdqREUsUUFBUyxJQU9WLE9BSEFFLEVBQW9CSixHQUFVSyxLQUFLRixFQUFPRCxRQUFTQyxFQUFRQSxFQUFPRCxRQUFTSCxHQUdwRUksRUFBT0QsUUNsQldILENBQW9CLEsiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS8uL3NyYy9pbmRleC50cyIsIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS8uL3NyYy91dGlscy9TaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyLnRzIiwid2VicGFjazovL2Fubm90b3Jpb3VzLXNhcy1zdG9yYWdlLy4vc3JjL3V0aWxzL2FkanVzdFRhcmdldFNvdXJjZS50cyIsIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS93ZWJwYWNrL2Jvb3RzdHJhcCIsIndlYnBhY2s6Ly9hbm5vdG9yaW91cy1zYXMtc3RvcmFnZS93ZWJwYWNrL3N0YXJ0dXAiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gYW5ub3RvcmlvdXMgcGx1Z2luIHRvIHVzZSBzaW1wbGUgYW5ub3RhdGlvbiBzZXJ2ZXIgYXMgYSBzdG9yYWdlXG5cbmltcG9ydCBTaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyIGZyb20gXCIuL3V0aWxzL1NpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXJcIjtcbmltcG9ydCBhZGp1c3RUYXJnZXRTb3VyY2UgZnJvbSBcIi4vdXRpbHMvYWRqdXN0VGFyZ2V0U291cmNlXCI7XG5pbXBvcnQgdHlwZSB7IEFubm90YXRpb24sIFNhdmVkQW5ub3RhdGlvbiB9IGZyb20gXCIuL3R5cGVzL1YzL0Fubm90YXRpb25cIjtcbmltcG9ydCB0eXBlIHsgQW5ub3RhdGlvblBhZ2UgfSBmcm9tIFwiLi90eXBlcy9WMy9Bbm5vdGF0aW9uUGFnZVwiO1xuaW1wb3J0IHR5cGUgeyBTZXR0aW5ncyB9IGZyb20gXCIuL3R5cGVzL1NldHRpbmdzXCI7XG5cbi8vIGRlZmluZSBhIGN1c3RvbSBldmVudCB0byBpbmRpY2F0ZSB0aGF0IGFubm90YXRpb25zIGhhdmUgYmVlbiBsb2FkZWRcbmNvbnN0IEFubm9Mb2FkRXZlbnQgPSBuZXcgRXZlbnQoXCJhbm5vdGF0aW9ucy1sb2FkZWRcIik7XG5cbmNsYXNzIEFubm90YXRpb25TZXJ2ZXJTdG9yYWdlIHtcbiAgICBhbm5vO1xuXG4gICAgc2V0dGluZ3M6IFNldHRpbmdzO1xuXG4gICAgYWRhcHRlcjogU2ltcGxlQW5ub3RhdGlvblNlcnZlclYyQWRhcHRlcjtcblxuICAgIC8vIFRPRE86IEFkZCBhIHR5cGVkZWYgZm9yIHRoZSBBbm5vdG9yaW91cyBjbGllbnQgKGFubm8pXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICBjb25zdHJ1Y3Rvcihhbm5vOiBhbnksIHNldHRpbmdzOiBTZXR0aW5ncykge1xuICAgICAgICB0aGlzLmFubm8gPSBhbm5vO1xuICAgICAgICB0aGlzLnNldHRpbmdzID0gc2V0dGluZ3M7XG4gICAgICAgIHRoaXMuYWRhcHRlciA9IG5ldyBTaW1wbGVBbm5vdGF0aW9uU2VydmVyVjJBZGFwdGVyKFxuICAgICAgICAgICAgc2V0dGluZ3MudGFyZ2V0LFxuICAgICAgICAgICAgc2V0dGluZ3MuYW5ub3RhdGlvbkVuZHBvaW50LFxuICAgICAgICApO1xuICAgICAgICAvLyBiaW5kIGV2ZW50IGhhbmRsZXJzXG4gICAgICAgIHRoaXMuYW5uby5vbihcImNyZWF0ZUFubm90YXRpb25cIiwgdGhpcy5oYW5kbGVDcmVhdGVBbm5vdGF0aW9uLmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLmFubm8ub24oXCJ1cGRhdGVBbm5vdGF0aW9uXCIsIHRoaXMuaGFuZGxlVXBkYXRlQW5ub3RhdGlvbi5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy5hbm5vLm9uKFwiZGVsZXRlQW5ub3RhdGlvblwiLCB0aGlzLmhhbmRsZURlbGV0ZUFubm90YXRpb24uYmluZCh0aGlzKSk7XG5cbiAgICAgICAgLy8gbG9hZCBhbm5vdGF0aW9ucyBmcm9tIHRoZSBzZXJ2ZXIgYW5kIHNpZ25hbCBmb3IgZGlzcGxheVxuICAgICAgICB0aGlzLmFkYXB0ZXIuYWxsKCkudGhlbigoYW5ub3RhdGlvblBhZ2U6IEFubm90YXRpb25QYWdlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFubm8uc2V0QW5ub3RhdGlvbnMoYW5ub3RhdGlvblBhZ2UuaXRlbXMpO1xuICAgICAgICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChBbm5vTG9hZEV2ZW50KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gaGFuZGxlIGNyZWF0ZSBhbm5vdGF0aW9uIGV2ZW50XG4gICAgYXN5bmMgaGFuZGxlQ3JlYXRlQW5ub3RhdGlvbihhbm5vdGF0aW9uOiBBbm5vdGF0aW9uKSB7XG4gICAgICAgIGFubm90YXRpb24udGFyZ2V0LnNvdXJjZSA9IGFkanVzdFRhcmdldFNvdXJjZShcbiAgICAgICAgICAgIGFubm90YXRpb24udGFyZ2V0LnNvdXJjZSxcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MsXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuYWRhcHRlci5jcmVhdGUoYW5ub3RhdGlvbikudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAvLyBieSBkZWZhdWx0LCBzdG9yYWdlIHJlbG9hZHMgYWxsIGFubm90YXRpb25zIGZvciB0aGlzIHBhZ2U7XG4gICAgICAgICAgICAvLyBzaWduYWwgdGhhdCBhbm5vdGF0aW9ucyBoYXZlIGJlZW4gbG9hZGVkXG4gICAgICAgICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KEFubm9Mb2FkRXZlbnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gaG93IHRvIHVwZGF0ZSBpZCBmb3IgYW5ub3RvcmlvdXM/XG4gICAgICAgIHRoaXMuYW5uby5hZGRBbm5vdGF0aW9uKGFubm90YXRpb24pO1xuICAgICAgICByZXR1cm4gYW5ub3RhdGlvbjtcbiAgICB9XG5cbiAgICAvLyB1cGRhdGUgYW4gYW5ub3RhdGlvblxuICAgIGhhbmRsZVVwZGF0ZUFubm90YXRpb24oYW5ub3RhdGlvbjogU2F2ZWRBbm5vdGF0aW9uLCBwcmV2aW91czogU2F2ZWRBbm5vdGF0aW9uKSB7XG5cbiAgICAgICAgLy8gVGhlIHBvc3RlZCBhbm5vdGF0aW9uIHNob3VsZCBoYXZlIGFuIEBpZCB3aGljaCBleGlzdHMgaW4gdGhlIHN0b3JlXG4gICAgICAgIC8vIGNvbnN0IG5ld0lkID0gYW5ub3RhdGlvbi5pZDsgLy8gZG8gd2UgbmVlZCB0byBkbyBhbnl0aGluZyB3aXRoIHRoaXM/XG4gICAgICAgIGFubm90YXRpb24uaWQgPSBwcmV2aW91cy5pZDtcbiAgICAgICAgLy8gdGFyZ2V0IG5lZWRzIHRvIGJlIHVwZGF0ZWQgaWYgdGhlIGltYWdlIHNlbGVjdGlvbiBoYXMgY2hhbmdlZFxuICAgICAgICBhbm5vdGF0aW9uLnRhcmdldC5zb3VyY2UgPSBhZGp1c3RUYXJnZXRTb3VyY2UoXG4gICAgICAgICAgICBhbm5vdGF0aW9uLnRhcmdldC5zb3VyY2UsXG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzLFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmFkYXB0ZXIudXBkYXRlKGFubm90YXRpb24pO1xuICAgICAgICAvLyBhZGQgdGhlIGFubm90YXRpb24gdG8gYW5ub3RvcmlvdXMgYWdhaW4gdG8gbWFrZSBzdXJlIHRoZSBkaXNwbGF5IGlzIHVwIHRvIGRhdGVcbiAgICAgICAgdGhpcy5hbm5vLmFkZEFubm90YXRpb24oYW5ub3RhdGlvbik7XG4gICAgfVxuXG4gICAgLy8gZGVsZXRlIGFuIGFubm90YXRpb25cbiAgICBoYW5kbGVEZWxldGVBbm5vdGF0aW9uKGFubm90YXRpb246IFNhdmVkQW5ub3RhdGlvbikge1xuICAgICAgICB0aGlzLmFkYXB0ZXIuZGVsZXRlKGFubm90YXRpb24uaWQpO1xuICAgIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBBbm5vdGF0aW9uU2VydmVyU3RvcmFnZTtcbiIsIi8qIENvbnZlcnQgYmV0d2VlbiB2MiAob3BlbiBhbm5vdGF0aW9uKSBhbmQgdjMgKHczYykgYW5ub3RhdGlvbnNcbiAgIGluIG9yZGVyIHRvIGJyaWRnZSBiZXR3ZWVuIGFubm90b3Jpb3VzICh3M2MpIGFuZCBzaW1wbGUgYW5ub3RhdGlvbiBzZXJ2ZXIgKHYyKS5cblxuICAgQWRhcHRlZCBmcm9tIG1pcmFkb3ItYW5ub3RhdGlvbnMgY29kZVxuICAgaHR0cHM6Ly9naXRodWIuY29tL1Byb2plY3RNaXJhZG9yL21pcmFkb3ItYW5ub3RhdGlvbnMvYmxvYi9tYXN0ZXIvc3JjL1NpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXIuanNcblxuKi9cblxuaW1wb3J0IHR5cGUgeyBBbm5vdGF0aW9uIGFzIFYyQW5ub3RhdGlvbiB9IGZyb20gXCIuLi90eXBlcy9WMi9Bbm5vdGF0aW9uXCI7XG5pbXBvcnQgdHlwZSB7IEFubm90YXRpb24gYXMgVjNBbm5vdGF0aW9uIH0gZnJvbSBcIi4uL3R5cGVzL1YzL0Fubm90YXRpb25cIjtcbmltcG9ydCB0eXBlIHsgQW5ub3RhdGlvblBhZ2UgfSBmcm9tIFwiLi4vdHlwZXMvVjMvQW5ub3RhdGlvblBhZ2VcIjtcbmltcG9ydCB0eXBlIHsgQm9keSBhcyBWMkJvZHkgfSBmcm9tIFwiLi4vdHlwZXMvVjIvQm9keVwiO1xuaW1wb3J0IHR5cGUgeyBCb2R5IGFzIFYzQm9keSB9IGZyb20gXCIuLi90eXBlcy9WMy9Cb2R5XCI7XG5pbXBvcnQgdHlwZSB7IFNlbGVjdG9yIGFzIFYyU2VsZWN0b3IgfSBmcm9tIFwiLi4vdHlwZXMvVjIvU2VsZWN0b3JcIjtcbmltcG9ydCB0eXBlIHsgU2VsZWN0b3IgYXMgVjNTZWxlY3RvciB9IGZyb20gXCIuLi90eXBlcy9WMy9TZWxlY3RvclwiO1xuaW1wb3J0IHR5cGUgeyBTb3VyY2UgfSBmcm9tIFwiLi4vdHlwZXMvVjMvU291cmNlXCI7XG5pbXBvcnQgdHlwZSB7IFRhcmdldCB9IGZyb20gXCIuLi90eXBlcy9WMy9UYXJnZXRcIjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2ltcGxlQW5ub3RhdGlvblNlcnZlclYyQWRhcHRlciB7XG4gICAgY2FudmFzSWQ6IHN0cmluZztcblxuICAgIGVuZHBvaW50VXJsOiBzdHJpbmc7XG5cbiAgICAvKiogKi9cbiAgICBjb25zdHJ1Y3RvcihjYW52YXNJZDogc3RyaW5nLCBlbmRwb2ludFVybDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuY2FudmFzSWQgPSBjYW52YXNJZDtcbiAgICAgICAgdGhpcy5lbmRwb2ludFVybCA9IGVuZHBvaW50VXJsO1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIGdldCBhbm5vdGF0aW9uUGFnZUlkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLmVuZHBvaW50VXJsfS9zZWFyY2g/dXJpPSR7dGhpcy5jYW52YXNJZH1gO1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIGFzeW5jIGNyZWF0ZShhbm5vdGF0aW9uOiBWM0Fubm90YXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGZldGNoKGAke3RoaXMuZW5kcG9pbnRVcmx9L2NyZWF0ZWAsIHtcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICAgIFNpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXIuY3JlYXRlVjJBbm5vKGFubm90YXRpb24pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICBBY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmFsbCgpKVxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHRoaXMuYWxsKCkpO1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIGFzeW5jIHVwZGF0ZShhbm5vdGF0aW9uOiBWM0Fubm90YXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGZldGNoKGAke3RoaXMuZW5kcG9pbnRVcmx9L3VwZGF0ZWAsIHtcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICAgIFNpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXIuY3JlYXRlVjJBbm5vKGFubm90YXRpb24pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICBBY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmFsbCgpKVxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHRoaXMuYWxsKCkpO1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIGFzeW5jIGRlbGV0ZShhbm5vSWQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gZmV0Y2goXG4gICAgICAgICAgICBgJHt0aGlzLmVuZHBvaW50VXJsfS9kZXN0cm95P3VyaT0ke2VuY29kZVVSSUNvbXBvbmVudChhbm5vSWQpfWAsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICAgICBBY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG1ldGhvZDogXCJERUxFVEVcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgIClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuYWxsKCkpXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4gdGhpcy5hbGwoKSk7XG4gICAgfVxuXG4gICAgLyoqICovXG4gICAgYXN5bmMgZ2V0KGFubm9JZDogc3RyaW5nKSB7XG4gICAgICAgIC8vIFNBUyBkb2VzIG5vdCBoYXZlIEdFVCBmb3IgYSBzaW5nbGUgYW5ub3RhdGlvblxuICAgICAgICBjb25zdCBhbm5vdGF0aW9uUGFnZSA9IGF3YWl0IHRoaXMuYWxsKCk7XG4gICAgICAgIGlmIChhbm5vdGF0aW9uUGFnZSkge1xuICAgICAgICAgICAgcmV0dXJuIGFubm90YXRpb25QYWdlLml0ZW1zLmZpbmQoXG4gICAgICAgICAgICAgICAgKGl0ZW06IFYzQW5ub3RhdGlvbikgPT4gaXRlbS5pZCA9PT0gYW5ub0lkLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvKiogUmV0dXJucyBhbiBBbm5vdGF0aW9uUGFnZSB3aXRoIGFsbCBhbm5vdGF0aW9ucyAqL1xuICAgIGFzeW5jIGFsbCgpOiBQcm9taXNlPEFubm90YXRpb25QYWdlPiB7XG4gICAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBmZXRjaCh0aGlzLmFubm90YXRpb25QYWdlSWQpO1xuICAgICAgICBjb25zdCBhbm5vcyA9IGF3YWl0IHJlc3AuanNvbigpO1xuICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVBbm5vdGF0aW9uUGFnZShhbm5vcyk7XG4gICAgfVxuXG4gICAgLyoqIENyZWF0ZXMgYSBWMiBhbm5vdGF0aW9uIGZyb20gYSBWMyBhbm5vdGF0aW9uICovXG4gICAgc3RhdGljIGNyZWF0ZVYyQW5ubyh2M2Fubm86IFYzQW5ub3RhdGlvbik6IFYyQW5ub3RhdGlvbiB7XG4gICAgICAgIGxldCByZXNvdXJjZSA9IG51bGw7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHYzYW5uby5ib2R5KSkge1xuICAgICAgICAgICAgcmVzb3VyY2UgPSB2M2Fubm8uYm9keS5tYXAoKGIpID0+IHRoaXMuY3JlYXRlVjJBbm5vQm9keShiKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvdXJjZSA9IHRoaXMuY3JlYXRlVjJBbm5vQm9keSh2M2Fubm8uYm9keSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdjJhbm5vOiBWMkFubm90YXRpb24gPSB7XG4gICAgICAgICAgICAvLyBjb3B5IGlkIGlmIGl0IGlzIFNBUy1nZW5lcmF0ZWRcbiAgICAgICAgICAgIC8vIFRPRE86IFdoYXQgaWQgdG8gdXNlIGlmIGl0IGlzIG5vdD9cbiAgICAgICAgICAgIFwiQGlkXCI6XG4gICAgICAgICAgICAgICAgdjNhbm5vLmlkICYmIHYzYW5uby5pZC5zdGFydHNXaXRoKFwiaHR0cFwiKVxuICAgICAgICAgICAgICAgICAgICA/IHYzYW5uby5pZFxuICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIFwiQGNvbnRleHRcIjogXCJodHRwOi8vaWlpZi5pby9hcGkvcHJlc2VudGF0aW9uLzIvY29udGV4dC5qc29uXCIsXG4gICAgICAgICAgICBcIkB0eXBlXCI6IFwib2E6QW5ub3RhdGlvblwiLFxuICAgICAgICAgICAgbW90aXZhdGlvbjogXCJvYTpjb21tZW50aW5nXCIsIC8vIFRPRE86IHVzZSB2M2Fubm8ubW90aXZhdGlvblxuICAgICAgICAgICAgb246IHtcbiAgICAgICAgICAgICAgICBcIkB0eXBlXCI6IFwib2E6U3BlY2lmaWNSZXNvdXJjZVwiLFxuICAgICAgICAgICAgICAgIGZ1bGw6ICh2M2Fubm8udGFyZ2V0LnNvdXJjZSBhcyBTb3VyY2UpLmlkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlc291cmNlLFxuICAgICAgICB9O1xuICAgICAgICBpZiAodjNhbm5vLnRhcmdldC5zZWxlY3Rvcikge1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodjNhbm5vLnRhcmdldC5zZWxlY3RvcikpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RvcnMgPSB2M2Fubm8udGFyZ2V0LnNlbGVjdG9yLm1hcCgocykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdjJTZWxlY3RvciA9IHRoaXMuY3JlYXRlVjJBbm5vU2VsZWN0b3Iocyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodjJTZWxlY3RvcikgcmV0dXJuIHYyU2VsZWN0b3I7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgY2hvaWNlLCBhc3N1bWluZyB0d28gZWxlbWVudHMgYW5kIDAgaXMgZGVmYXVsdFxuICAgICAgICAgICAgICAgIHYyYW5uby5vbi5zZWxlY3RvciA9IHtcbiAgICAgICAgICAgICAgICAgICAgXCJAdHlwZVwiOiBcIm9hOkNob2ljZVwiLFxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OiBzZWxlY3RvcnNbMF0sXG4gICAgICAgICAgICAgICAgICAgIGl0ZW06IHNlbGVjdG9yc1sxXSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2MlNlbGVjdG9yID0gdGhpcy5jcmVhdGVWMkFubm9TZWxlY3RvcihcbiAgICAgICAgICAgICAgICAgICAgdjNhbm5vLnRhcmdldC5zZWxlY3RvcixcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGlmICh2MlNlbGVjdG9yKSB2MmFubm8ub24uc2VsZWN0b3IgPSB2MlNlbGVjdG9yO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCh2M2Fubm8udGFyZ2V0LnNvdXJjZSBhcyBTb3VyY2UpLnBhcnRPZikge1xuICAgICAgICAgICAgICAgIHYyYW5uby5vbi53aXRoaW4gPSB7XG4gICAgICAgICAgICAgICAgICAgIFwiQGlkXCI6ICh2M2Fubm8udGFyZ2V0LnNvdXJjZSBhcyBTb3VyY2UpLnBhcnRPZi5pZCxcbiAgICAgICAgICAgICAgICAgICAgXCJAdHlwZVwiOiBcInNjOk1hbmlmZXN0XCIsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdjJhbm5vO1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIHN0YXRpYyBjcmVhdGVWMkFubm9Cb2R5KHYzYm9keTogVjNCb2R5KSB7XG4gICAgICAgIGNvbnN0IHYyYm9keTogVjJCb2R5ID0ge1xuICAgICAgICAgICAgXCJAdHlwZVwiOiB2M2JvZHkucHVycG9zZSA9PT0gXCJ0YWdnaW5nXCIgPyBcIm9hOlRhZ1wiIDogXCJkY3R5cGVzOlRleHRcIixcbiAgICAgICAgICAgIGNoYXJzOiB2M2JvZHkudmFsdWUsXG4gICAgICAgIH07XG4gICAgICAgIGlmICh2M2JvZHkuZm9ybWF0KSB7XG4gICAgICAgICAgICB2MmJvZHkuZm9ybWF0ID0gdjNib2R5LmZvcm1hdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodjNib2R5Lmxhbmd1YWdlKSB7XG4gICAgICAgICAgICB2MmJvZHkubGFuZ3VhZ2UgPSB2M2JvZHkubGFuZ3VhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHYyYm9keTtcbiAgICB9XG5cbiAgICAvKiogKi9cbiAgICBzdGF0aWMgY3JlYXRlVjJBbm5vU2VsZWN0b3IodjNzZWxlY3RvcjogVjNTZWxlY3Rvcik6IFYyU2VsZWN0b3IgfCBudWxsIHtcbiAgICAgICAgc3dpdGNoICh2M3NlbGVjdG9yLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgXCJTdmdTZWxlY3RvclwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIFwiQHR5cGVcIjogXCJvYTpTdmdTZWxlY3RvclwiLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdjNzZWxlY3Rvci52YWx1ZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgY2FzZSBcIkZyYWdtZW50U2VsZWN0b3JcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBcIkB0eXBlXCI6IFwib2E6RnJhZ21lbnRTZWxlY3RvclwiLFxuICAgICAgICAgICAgICAgICAgICAvLyBTQVMgdXNlcyBsb2NhdGlvbiBpbiB4eXdoPXgseSx3LGggZm9ybWF0OyBhbm5vdG9yaW91cyB1c2VzIHBpeGVsOngseSx3LGhcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHYzc2VsZWN0b3IudmFsdWUucmVwbGFjZShcInh5d2g9cGl4ZWw6XCIsIFwieHl3aD1cIiksXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiogQ3JlYXRlcyBhbiBBbm5vdGF0aW9uUGFnZSBmcm9tIGEgbGlzdCBvZiBWMiBhbm5vdGF0aW9ucyAqL1xuICAgIGNyZWF0ZUFubm90YXRpb25QYWdlKHYyYW5ub3M6IFYyQW5ub3RhdGlvbltdKTogQW5ub3RhdGlvblBhZ2Uge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2MmFubm9zKSkge1xuICAgICAgICAgICAgY29uc3QgdjNhbm5vcyA9IHYyYW5ub3MubWFwKChhKSA9PlxuICAgICAgICAgICAgICAgIFNpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXIuY3JlYXRlVjNBbm5vKGEpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRoaXMuYW5ub3RhdGlvblBhZ2VJZCxcbiAgICAgICAgICAgICAgICBpdGVtczogdjNhbm5vcyxcbiAgICAgICAgICAgICAgICB0eXBlOiBcIkFubm90YXRpb25QYWdlXCIsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2MmFubm9zO1xuICAgIH1cblxuICAgIC8qKiBDcmVhdGVzIGEgVjMgYW5ub3RhdGlvbiBmcm9tIGEgVjIgYW5ub3RhdGlvbiAqL1xuICAgIHN0YXRpYyBjcmVhdGVWM0Fubm8odjJhbm5vOiBWMkFubm90YXRpb24pOiBWM0Fubm90YXRpb24ge1xuICAgICAgICBsZXQgYm9keSA9IG51bGw7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHYyYW5uby5yZXNvdXJjZSkpIHtcbiAgICAgICAgICAgIGJvZHkgPSB2MmFubm8ucmVzb3VyY2UubWFwKChiOiBWMkJvZHkpID0+IHRoaXMuY3JlYXRlVjNBbm5vQm9keShiKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBib2R5ID0gdGhpcy5jcmVhdGVWM0Fubm9Cb2R5KHYyYW5uby5yZXNvdXJjZSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHYydGFyZ2V0ID0gdjJhbm5vLm9uO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2MnRhcmdldCkpIHtcbiAgICAgICAgICAgIFt2MnRhcmdldF0gPSB2MnRhcmdldDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0YXJnZXQ6IFRhcmdldCA9IHtcbiAgICAgICAgICAgIHNlbGVjdG9yOiB2MnRhcmdldC5zZWxlY3RvclxuICAgICAgICAgICAgICAgID8gdGhpcy5jcmVhdGVWM0Fubm9TZWxlY3Rvcih2MnRhcmdldC5zZWxlY3RvcilcbiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHNvdXJjZTogdjJ0YXJnZXQuZnVsbCxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHYydGFyZ2V0LndpdGhpbikge1xuICAgICAgICAgICAgdGFyZ2V0LnNvdXJjZSA9IHtcbiAgICAgICAgICAgICAgICBpZDogdjJ0YXJnZXQuZnVsbCxcbiAgICAgICAgICAgICAgICBwYXJ0T2Y6IHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHYydGFyZ2V0LndpdGhpbltcIkBpZFwiXSxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJNYW5pZmVzdFwiLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdHlwZTogXCJDYW52YXNcIixcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFwiQGNvbnRleHRcIjogXCJodHRwOi8vd3d3LnczLm9yZy9ucy9hbm5vLmpzb25sZFwiLFxuICAgICAgICAgICAgaWQ6IHYyYW5ub1tcIkBpZFwiXSxcbiAgICAgICAgICAgIG1vdGl2YXRpb246IFwiY29tbWVudGluZ1wiLFxuICAgICAgICAgICAgdHlwZTogXCJBbm5vdGF0aW9uXCIsXG4gICAgICAgICAgICB0YXJnZXQsXG4gICAgICAgICAgICBib2R5LFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIHN0YXRpYyBjcmVhdGVWM0Fubm9Cb2R5KHYyYm9keTogVjJCb2R5KTogVjNCb2R5IHtcbiAgICAgICAgY29uc3QgdjNib2R5OiBWM0JvZHkgPSB7XG4gICAgICAgICAgICB0eXBlOiBcIlRleHR1YWxCb2R5XCIsXG4gICAgICAgICAgICB2YWx1ZTogdjJib2R5LmNoYXJzLFxuICAgICAgICB9O1xuICAgICAgICBpZiAodjJib2R5LmZvcm1hdCkge1xuICAgICAgICAgICAgdjNib2R5LmZvcm1hdCA9IHYyYm9keS5mb3JtYXQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHYyYm9keS5sYW5ndWFnZSkge1xuICAgICAgICAgICAgdjNib2R5Lmxhbmd1YWdlID0gdjJib2R5Lmxhbmd1YWdlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2MmJvZHlbXCJAdHlwZVwiXSA9PT0gXCJvYTpUYWdcIikge1xuICAgICAgICAgICAgdjNib2R5LnB1cnBvc2UgPSBcInRhZ2dpbmdcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdjNib2R5O1xuICAgIH1cblxuICAgIC8qKiAqL1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgc3RhdGljIGNyZWF0ZVYzQW5ub1NlbGVjdG9yKHYyc2VsZWN0b3I6IFYyU2VsZWN0b3IpOiBhbnkge1xuICAgICAgICAvLyBUT0RPOiB0eXBlLXNhZmUgdGhpcyByZXR1cm4gdmFsdWVcbiAgICAgICAgc3dpdGNoICh2MnNlbGVjdG9yW1wiQHR5cGVcIl0pIHtcbiAgICAgICAgICAgIGNhc2UgXCJvYTpTdmdTZWxlY3RvclwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiU3ZnU2VsZWN0b3JcIixcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHYyc2VsZWN0b3IudmFsdWUsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNhc2UgXCJvYTpGcmFnbWVudFNlbGVjdG9yXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJGcmFnbWVudFNlbGVjdG9yXCIsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZvcm1zVG86IFwiaHR0cDovL3d3dy53My5vcmcvVFIvbWVkaWEtZnJhZ3MvXCIsXG4gICAgICAgICAgICAgICAgICAgIC8vIFNBUyByZXR1cm5zIGxvY2F0aW9uIGluIHh5d2g9eCx5LHcsaCBmb3JtYXQ7IGFubm90b3Jpb3VzIHVzZXMgcGl4ZWw6eCx5LHcsaFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdjJzZWxlY3Rvci52YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgPyB2MnNlbGVjdG9yLnZhbHVlLnJlcGxhY2UoXCJ4eXdoPVwiLCBcInh5d2g9cGl4ZWw6XCIpXG4gICAgICAgICAgICAgICAgICAgICAgICA6IFwiXCIsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNhc2UgXCJvYTpDaG9pY2VcIjpcbiAgICAgICAgICAgICAgICAvKiBjcmVhdGUgYWx0ZXJuYXRlIHNlbGVjdG9ycyAqL1xuICAgICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgICAgIHYyc2VsZWN0b3IuZGVmYXVsdFxuICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmNyZWF0ZVYzQW5ub1NlbGVjdG9yKHYyc2VsZWN0b3IuZGVmYXVsdClcbiAgICAgICAgICAgICAgICAgICAgICAgIDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgdjJzZWxlY3Rvci5pdGVtXG4gICAgICAgICAgICAgICAgICAgICAgICA/IHRoaXMuY3JlYXRlVjNBbm5vU2VsZWN0b3IodjJzZWxlY3Rvci5pdGVtKVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBudWxsLFxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxufVxuIiwiaW1wb3J0IHsgU2V0dGluZ3MgfSBmcm9tIFwiLi4vdHlwZXMvU2V0dGluZ3NcIjtcbmltcG9ydCB7IFNvdXJjZSB9IGZyb20gXCIuLi90eXBlcy9WMy9Tb3VyY2VcIjtcblxuY29uc3QgYWRqdXN0VGFyZ2V0U291cmNlID0gKFxuICAgIHNvdXJjZTogU291cmNlIHwgc3RyaW5nLFxuICAgIHNldHRpbmdzOiBTZXR0aW5ncyxcbik6IFNvdXJjZSA9PiB7XG4gICAgLy8gYW5ub3RvcmlvdXMgc2V0cyB0aGUgdGFyZ2V0IHNvdXJjZSBhcyBhIHN0cmluZyBpZDtcbiAgICAvLyB3ZSBuZWVkIHRvIHN0cnVjdHVyZSBpdCB0byBhZGQgY2FudmFzL21hbmlmZXN0IGluZm9cbiAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIC8vIGFkZCBtYW5pZmVzdCBpZCB0byBhbm5vdGF0aW9uXG4gICAgICAgIHNvdXJjZSA9IHtcbiAgICAgICAgICAgIC8vIHVzZSB0aGUgY29uZmlndXJlZCB0YXJnZXQgKHNob3VsZCBiZSBjYW52YXMgaWQpXG4gICAgICAgICAgICBpZDogc2V0dGluZ3MudGFyZ2V0LFxuICAgICAgICAgICAgLy8gbGluayB0byBjb250YWluaW5nIG1hbmlmZXN0XG4gICAgICAgICAgICBwYXJ0T2Y6IHtcbiAgICAgICAgICAgICAgICBpZDogc2V0dGluZ3MubWFuaWZlc3QsXG4gICAgICAgICAgICAgICAgdHlwZTogXCJNYW5pZmVzdFwiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHR5cGU6IFwiQ2FudmFzXCIsXG4gICAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiBzb3VyY2U7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhZGp1c3RUYXJnZXRTb3VyY2U7XG4iLCIvLyBUaGUgbW9kdWxlIGNhY2hlXG52YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307XG5cbi8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uXG5mdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7XG5cdC8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZVxuXHR2YXIgY2FjaGVkTW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXTtcblx0aWYgKGNhY2hlZE1vZHVsZSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0cmV0dXJuIGNhY2hlZE1vZHVsZS5leHBvcnRzO1xuXHR9XG5cdC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpXG5cdHZhciBtb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdID0ge1xuXHRcdC8vIG5vIG1vZHVsZS5pZCBuZWVkZWRcblx0XHQvLyBubyBtb2R1bGUubG9hZGVkIG5lZWRlZFxuXHRcdGV4cG9ydHM6IHt9XG5cdH07XG5cblx0Ly8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uXG5cdF9fd2VicGFja19tb2R1bGVzX19bbW9kdWxlSWRdLmNhbGwobW9kdWxlLmV4cG9ydHMsIG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pO1xuXG5cdC8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlXG5cdHJldHVybiBtb2R1bGUuZXhwb3J0cztcbn1cblxuIiwiLy8gc3RhcnR1cFxuLy8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzXG4vLyBUaGlzIGVudHJ5IG1vZHVsZSBpcyByZWZlcmVuY2VkIGJ5IG90aGVyIG1vZHVsZXMgc28gaXQgY2FuJ3QgYmUgaW5saW5lZFxudmFyIF9fd2VicGFja19leHBvcnRzX18gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYwNyk7XG4iXSwibmFtZXMiOlsiQW5ub0xvYWRFdmVudCIsIkV2ZW50IiwiY29uc3RydWN0b3IiLCJhbm5vIiwic2V0dGluZ3MiLCJ0aGlzIiwiYWRhcHRlciIsInRhcmdldCIsImFubm90YXRpb25FbmRwb2ludCIsIm9uIiwiaGFuZGxlQ3JlYXRlQW5ub3RhdGlvbiIsImJpbmQiLCJoYW5kbGVVcGRhdGVBbm5vdGF0aW9uIiwiaGFuZGxlRGVsZXRlQW5ub3RhdGlvbiIsImFsbCIsInRoZW4iLCJhbm5vdGF0aW9uUGFnZSIsInNldEFubm90YXRpb25zIiwiaXRlbXMiLCJkb2N1bWVudCIsImRpc3BhdGNoRXZlbnQiLCJhc3luYyIsImFubm90YXRpb24iLCJzb3VyY2UiLCJjcmVhdGUiLCJhZGRBbm5vdGF0aW9uIiwicHJldmlvdXMiLCJpZCIsInVwZGF0ZSIsImRlbGV0ZSIsIlNpbXBsZUFubm90YXRpb25TZXJ2ZXJWMkFkYXB0ZXIiLCJjYW52YXNJZCIsImVuZHBvaW50VXJsIiwiYW5ub3RhdGlvblBhZ2VJZCIsImZldGNoIiwiYm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJjcmVhdGVWMkFubm8iLCJoZWFkZXJzIiwiQWNjZXB0IiwibWV0aG9kIiwiY2F0Y2giLCJhbm5vSWQiLCJlbmNvZGVVUklDb21wb25lbnQiLCJmaW5kIiwiaXRlbSIsInJlc3AiLCJhbm5vcyIsImpzb24iLCJjcmVhdGVBbm5vdGF0aW9uUGFnZSIsInN0YXRpYyIsInYzYW5ubyIsInJlc291cmNlIiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwiYiIsImNyZWF0ZVYyQW5ub0JvZHkiLCJ2MmFubm8iLCJzdGFydHNXaXRoIiwidW5kZWZpbmVkIiwibW90aXZhdGlvbiIsImZ1bGwiLCJzZWxlY3RvciIsInNlbGVjdG9ycyIsInMiLCJ2MlNlbGVjdG9yIiwiY3JlYXRlVjJBbm5vU2VsZWN0b3IiLCJkZWZhdWx0IiwicGFydE9mIiwid2l0aGluIiwidjNib2R5IiwidjJib2R5IiwicHVycG9zZSIsImNoYXJzIiwidmFsdWUiLCJmb3JtYXQiLCJsYW5ndWFnZSIsInYzc2VsZWN0b3IiLCJ0eXBlIiwicmVwbGFjZSIsInYyYW5ub3MiLCJ2M2Fubm9zIiwiYSIsImNyZWF0ZVYzQW5ubyIsImNyZWF0ZVYzQW5ub0JvZHkiLCJ2MnRhcmdldCIsImNyZWF0ZVYzQW5ub1NlbGVjdG9yIiwidjJzZWxlY3RvciIsImNvbmZvcm1zVG8iLCJtYW5pZmVzdCIsIl9fd2VicGFja19tb2R1bGVfY2FjaGVfXyIsIl9fd2VicGFja19leHBvcnRzX18iLCJfX3dlYnBhY2tfcmVxdWlyZV9fIiwibW9kdWxlSWQiLCJjYWNoZWRNb2R1bGUiLCJleHBvcnRzIiwibW9kdWxlIiwiX193ZWJwYWNrX21vZHVsZXNfXyIsImNhbGwiXSwic291cmNlUm9vdCI6IiJ9